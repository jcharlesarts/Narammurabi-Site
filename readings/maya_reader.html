<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maya — Reading Helper (Chunked)</title>
  <style>
    @font-face {
      font-family: "Apercu Light";
      src: local("Apercu Light"), local("Apercu-Light"), local("Apercu Pro Light"), local("ApercuPro-Light");
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --bg: #0f172a;
      --card: #111827;
      --ink: #e5e7eb;
      --muted: #cbd5e1;
      --accent: #38bdf8;
      --accent2: #a78bfa;
      --good: #34d399;
      --warn: #fbbf24;
      --bad: #fb7185;
      --line: rgba(255, 255, 255, .12);
    }

    body[data-theme="light"] {
      --bg: #f8fafc;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #334155;
      --accent: #0284c7;
      --accent2: #6d28d9;
      --good: #059669;
      --warn: #b45309;
      --bad: #be123c;
      --line: rgba(15, 23, 42, .16);
    }

    body[data-theme="light"] {
      background: radial-gradient(1100px 700px at 15% 10%, rgba(2, 132, 199, .12), transparent 60%),
        radial-gradient(1100px 700px at 85% 20%, rgba(109, 40, 217, .10), transparent 55%),
        var(--bg);
      color: var(--ink);
    }

    body[data-theme="light"] .card {
      background: rgba(255, 255, 255, .92);
      box-shadow: 0 10px 24px rgba(15, 23, 42, .10);
    }

    body[data-theme="light"] button {
      background: rgba(15, 23, 42, .04);
    }

    body[data-theme="light"] button:hover {
      background: rgba(15, 23, 42, .07);
    }

    body[data-theme="light"] .box {
      background: rgba(15, 23, 42, .03);
    }

    body[data-theme="light"] .vocab {
      border-bottom: 1px dotted rgba(2, 132, 199, .7);
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1100px 700px at 15% 10%, rgba(56, 189, 248, .14), transparent 60%),
        radial-gradient(1100px 700px at 85% 20%, rgba(167, 139, 250, .14), transparent 55%),
        var(--bg);
      color: var(--ink);
      line-height: 1.45;
    }

    header {
      padding: 18px 18px 10px;
      max-width: 1040px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
      justify-content: space-between;
    }

    header h1 {
      margin: 0;
      font-size: 1.45rem;
      letter-spacing: .2px;
    }

    header .sub {
      margin: 2px 0 0;
      color: var(--muted);
      font-size: .95rem;
    }

    .wrap {
      max-width: 1040px;
      margin: 0 auto;
      padding: 12px 18px 26px;
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }

    .card {
      background: rgba(17, 24, 39, .86);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, .25);
      padding: 16px;
    }

    .chunk-title {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 0 0 8px;
      flex-wrap: wrap;
    }

    .pill {
      font-size: .82rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .04);
      color: var(--muted);
      white-space: nowrap;
    }

    .pill.accent {
      color: var(--accent);
      border-color: rgba(56, 189, 248, .35);
    }

    .pill.violet {
      color: var(--accent2);
      border-color: rgba(167, 139, 250, .35);
    }

    .pill.good {
      color: var(--good);
      border-color: rgba(52, 211, 153, .35);
    }

    .pill.warn {
      color: var(--warn);
      border-color: rgba(251, 191, 36, .35);
    }

    .chunk h2 {
      margin: 0;
      font-size: 1.25rem;
    }

    .chunk p {
      margin: 10px 0 0;
      font-size: 1.03rem;
    }

    #chunkBody p {
      font-family: "Apercu Light", "Apercu", "Aperchu Light", "Aperchu", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 300;
    }

    /* Reading font size (LEFT card only) */
    .chunk.reading-sm #chunkBody {
      font-size: 0.98rem;
    }

    .chunk.reading-md #chunkBody {
      font-size: 1.05rem;
    }

    .chunk.reading-lg #chunkBody {
      font-size: 1.15rem;
    }

    .chunk.reading-xl #chunkBody {
      font-size: 1.28rem;
    }

    .chunk.reading-sm #chunkBody p,
    .chunk.reading-sm #chunkBody li {
      font-size: 0.98rem;
    }

    .chunk.reading-md #chunkBody p,
    .chunk.reading-md #chunkBody li {
      font-size: 1.05rem;
    }

    .chunk.reading-lg #chunkBody p,
    .chunk.reading-lg #chunkBody li {
      font-size: 1.15rem;
    }

    .chunk.reading-xl #chunkBody p,
    .chunk.reading-xl #chunkBody li {
      font-size: 1.28rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
      align-items: center;
      justify-content: space-between;
    }

    button {
      appearance: none;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .06);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 650;
      letter-spacing: .2px;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }

    button:hover {
      background: rgba(255, 255, 255, .09);
      border-color: rgba(255, 255, 255, .22);
    }

    button:active {
      transform: translateY(1px);
    }

    button:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .btn-primary {
      border-color: rgba(56, 189, 248, .35);
      background: rgba(56, 189, 248, .12);
    }

    .btn-primary:hover {
      background: rgba(56, 189, 248, .16);
    }

    .btn-secondary {
      border-color: rgba(167, 139, 250, .35);
      background: rgba(167, 139, 250, .12);
    }

    .btn-secondary:hover {
      background: rgba(167, 139, 250, .16);
    }

    .btn-hint {
      border-color: rgba(251, 191, 36, .35);
      background: rgba(251, 191, 36, .10);
    }

    .btn-hint:hover {
      background: rgba(251, 191, 36, .14);
    }

    .progress {
      font-size: .92rem;
      color: var(--muted);
    }

    /* Right side */
    .panel h3 {
      margin: 0 0 8px;
      font-size: 1.15rem;
    }

    .chunk-title .pill {
      font-size: .86rem;
    }

    .chunk-title {
      margin-bottom: 10px;
    }

    .box {
      background: rgba(255, 255, 255, .04);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
    }

    .next-task {
      border-left: 4px solid rgba(56, 189, 248, .6);
    }

    .next-task strong {
      color: var(--accent);
    }

    .hints {
      border-left: 4px solid rgba(251, 191, 36, .7);
      display: none;
    }

    .hints strong {
      color: var(--warn);
    }

    .rules {
      border-left: 4px solid rgba(52, 211, 153, .6);
    }

    .rules strong {
      color: var(--good);
    }

    /* Vocab */
    .vocab {
      color: var(--accent);
      font-weight: 750;
      cursor: pointer;
      border-bottom: 1px dotted rgba(56, 189, 248, .7);
      padding: 0 2px;
      border-radius: 6px;
      transition: background .15s ease, box-shadow .15s ease, transform .05s ease;
    }

    .vocab:hover {
      background: rgba(56, 189, 248, .12);
    }

    .vocab:active {
      transform: translateY(1px);
    }

    .vocab:focus {
      outline: none;
    }

    .vocab:focus-visible {
      box-shadow: 0 0 0 3px rgba(56, 189, 248, .4);
    }

    .vocab.vocab-active {
      background: rgba(56, 189, 248, .18);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, .35);
    }

    .vocab.vocab-selected {
      background: rgba(56, 189, 248, .22);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, .55);
    }

    .vocab-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .vocab-items {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      max-height: 320px;
      overflow: auto;
      padding-right: 6px;
    }

    .vocab-item {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      background: rgba(255, 255, 255, .05);
      color: var(--ink);
      font-weight: 700;
      text-align: left;
    }

    .vocab-item:hover {
      background: rgba(56, 189, 248, .12);
    }

    .vocab-item.active {
      border-color: rgba(56, 189, 248, .6);
      background: rgba(56, 189, 248, .18);
    }

    .vocab-def {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, .03);
      min-height: 120px;
    }

    .vocab-def strong {
      display: block;
      margin-bottom: 6px;
    }

    .vocab-def .muted {
      color: var(--muted);
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding: 24px 16px;
      z-index: 50;
    }

    .modal {
      max-width: 640px;
      width: 100%;
      max-height: calc(100vh - 48px);
      display: flex;
      flex-direction: column;
      background: rgba(17, 24, 39, .96);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, .45);
      padding: 16px 16px 12px;
    }

    .modal h4 {
      margin: 0 0 6px;
      font-size: 1.05rem;
    }

    .modal p {
      margin: 0 0 12px;
      color: var(--muted);
    }

    .modal .row {
      display: flex;
      justify-content: flex-end;
    }

    .modal-body {
      overflow: auto;
      min-height: 0;
      padding-right: 4px;
    }

    /* Early finisher */
    .finisher-wrap {
      margin-top: 14px;
      border-top: 1px solid var(--line);
      padding-top: 14px;
      display: none;
    }

    .finisher-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .finisher-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 10px 0;
    }

    .finisher-tab {
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .05);
      padding: 8px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 700;
      color: var(--muted);
    }

    .finisher-tab.active {
      color: var(--ink);
      border-color: rgba(56, 189, 248, .35);
      background: rgba(56, 189, 248, .12);
    }

    .finisher-panel {
      display: none;
    }

    .finisher-panel.active {
      display: block;
    }

    .img-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .img-card {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(255, 255, 255, .03);
      padding: 10px;
      position: relative;
    }

    .img-card h4 {
      margin: 0 0 6px;
      font-size: .98rem;
    }

    .img-card img {
      width: 100%;
      max-height: 120px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .03);
      cursor: zoom-in;
      transition: max-height .2s ease, transform .2s ease;
    }

    .img-card.expanded img {
      max-height: 260px;
      transform: scale(1.01);
      cursor: zoom-out;
    }

    .img-card .img-close {
      position: absolute;
      top: 8px;
      right: 8px;
      border: 1px solid var(--line);
      background: rgba(0, 0, 0, .5);
      color: var(--ink);
      font-weight: 800;
      padding: 4px 8px;
      border-radius: 999px;
      cursor: pointer;
      display: none;
    }

    .img-card.expanded .img-close {
      display: inline-flex;
    }

    .img-card p {
      margin: 8px 0 8px;
      color: var(--muted);
      font-size: .95rem;
    }

    .line-fill {
      margin-top: 6px;
      color: var(--muted);
    }

    .blank {
      display: inline-block;
      min-width: 160px;
      border-bottom: 2px solid rgba(255, 255, 255, .22);
      transform: translateY(-1px);
    }

    .quiz-q {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, .03);
      margin-top: 10px;
    }

    .quiz-q .q {
      font-weight: 800;
    }

    .quiz-opts {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 10px;
    }

    .quiz-opt {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      cursor: pointer;
      background: rgba(255, 255, 255, .05);
      color: var(--ink);
      font-weight: 700;
    }

    .quiz-opt:hover {
      background: rgba(255, 255, 255, .08);
    }

    .quiz-opt.correct {
      border-color: rgba(52, 211, 153, .55);
      background: rgba(52, 211, 153, .16);
    }

    .quiz-opt.wrong {
      border-color: rgba(251, 113, 133, .55);
      background: rgba(251, 113, 133, .14);
    }

    @media (max-width: 940px) {
      .wrap {
        grid-template-columns: 1fr;
      }

      .img-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header>
    <div>
      <h1>The Maya — Reading Helper</h1>
      <div class="sub">Read the chunked lesson → answer the checkpoint questions → then do Maya Picture Analysis.</div>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button id="btnTheme" type="button" class="btn-secondary" aria-label="Toggle light/dark mode">Bright Mode</button>
      <div class="progress" id="progressText">Slide 1 of 7</div>
    </div>
  </header>

  <main class="wrap">
    <!-- LEFT: Reading chunk -->
    <section class="card chunk reading-md" aria-live="polite">
      <div class="chunk-title">
        <span class="pill accent" id="unitTag">Civilization: The Maya</span>
        <span class="pill violet" id="chunkTag">Chunk</span>
        <span class="pill" id="skillTag">Skill: Evidence</span>
        <span class="pill good" id="sourceTag">Info Source: Maya Reading</span>
      </div>

      <h2 id="chunkTitle">Welcome</h2>
      <div id="chunkBody"></div>

      <div class="box" id="pictureAnalysisBox" style="display:none; border-left: 4px solid rgba(167,139,250,.6);">
        <strong style="color: var(--accent2);">Worksheet Part: Picture Analysis</strong>
        <div style="color:var(--muted); margin-top:6px;">
          Look at the picture. On your worksheet, describe <b>one challenge</b> and <b>one unique thing</b> for the Maya, then add <b>evidence</b> (copy 4–6 words from the caption or the slide).
        </div>
        <div class="img-grid" style="margin-top:10px; grid-template-columns: 1fr;">
          <div class="img-card" data-picture="0">
            <button type="button" class="img-close" aria-label="Close expanded image">Close</button>
            <h4>Maya</h4>
            <img
              src="https://images.squarespace-cdn.com/content/v1/6047d405b02148755fb6e601/42c604a2-9471-4d64-a922-c72b94d17a12/ver-centroamerica-guatemala-ruinas-tikal-04.jpg?format=2500w"
              alt="Maya ruins at Tikal (Guatemala)" />
            <p><b>What you’re seeing:</b> Jungle region with stone cities and temples.</p>
            <p><b>Quick question:</b> What challenge would builders face in a hot, wet jungle?</p>
            <div class="line-fill"><b>Challenge:</b> <span class="blank"></span></div>
            <div class="line-fill"><b>Unique thing:</b> <span class="blank"></span></div>
            <div class="line-fill"><b>Evidence (4–6 words):</b> <span class="blank" style="min-width:220px;"></span></div>
          </div>

          <div class="img-card" data-picture="1">
            <button type="button" class="img-close" aria-label="Close expanded image">Close</button>
            <h4>Dresden Codex (Maya)</h4>
            <img
              src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/Dresden_Codex_pp.58-62_78.jpg/500px-Dresden_Codex_pp.58-62_78.jpg"
              alt="Pages from the Dresden Codex (Maya book)" />
            <p><b>What you’re seeing:</b> A Maya <span class="vocab" data-vocab="codex">codex</span> with <span class="vocab" data-vocab="glyph">glyphs</span> (symbols) used to record information.</p>
            <p><b>Quick question:</b> What does this tell you about what the Maya valued (and why)?</p>
            <div class="line-fill"><b>Challenge:</b> <span class="blank"></span></div>
            <div class="line-fill"><b>Unique thing:</b> <span class="blank"></span></div>
            <div class="line-fill"><b>Evidence (4–6 words):</b> <span class="blank" style="min-width:220px;"></span></div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn-secondary" id="btnPrev" type="button">← Back</button>
          <button class="btn-primary" id="btnNext" type="button">Next →</button>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <button class="btn-hint" id="btnHint" type="button">Hint</button>
          <button id="btnVocab" type="button">Vocab List</button>
          <button id="btnSpanish" type="button" class="btn-secondary">Spanish Helper (ELL)</button>
          <span style="width:1px; height:22px; background: var(--line); display:inline-block;"></span>
          <span style="color:var(--muted); font-size:.92rem;">Reading size:</span>
          <button id="btnFontSm" type="button" aria-label="Smaller reading text">A-</button>
          <button id="btnFontMd" type="button" aria-label="Default reading text">A</button>
          <button id="btnFontLg" type="button" aria-label="Larger reading text">A+</button>
          <button id="btnFontXl" type="button" aria-label="Extra large reading text">A++</button>
        </div>
      </div>

      <!-- Early finisher: only appears on final chunk -->
      <div class="finisher-wrap" id="finisherWrap">
        <div class="finisher-head">
          <div>
            <span class="pill warn">Early Finisher (Optional)</span>
            <span class="pill">Pick ONE</span>
          </div>
          <button id="btnFinisherToggle" type="button" class="btn-secondary">Open Choice Board</button>
        </div>

        <div class="finisher-tabs" id="finisherTabs">
          <div class="finisher-tab active" data-finisher-tab="match">Vocab Quick Match</div>
          <div class="finisher-tab" data-finisher-tab="compare">1‑Min Compare</div>
        </div>

        <div class="finisher-panel active" data-finisher-panel="match">
          <div style="color:var(--muted); margin-top:6px;">Tap an answer. It will check itself.</div>
          <div id="finisherQuiz"></div>
        </div>

        <div class="finisher-panel" data-finisher-panel="compare">
          <div class="quiz-q" style="margin-top:10px;">
            <div class="q">Pick TWO civilizations. Write one geography difference and how it changes life.</div>
            <div style="margin-top:10px; color:var(--muted);">
              Geography difference: <span class="blank" style="min-width: 260px;"></span>
            </div>
            <div style="margin-top:10px; color:var(--muted);">
              How it changes life: <span class="blank" style="min-width: 300px;"></span>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- RIGHT: worksheet directions + hints -->
    <aside class="card panel">
      <h3>Worksheet Checkpoint</h3>

      <div class="box rules">
        <strong>Rules</strong>
        <div style="color:var(--muted); margin-top:6px;">
          <div>✅ Every answer should match the reading.</div>
          <div>✅ Use <b>evidence</b> when the worksheet asks for it (copy 4–6 words from the slide).</div>
          <div>✅ If stuck: re-read → ask partner → raise hand.</div>
        </div>
      </div>

      <div class="box next-task" id="nextTaskBox">
        <strong>After reading, do this now:</strong>
        <div id="nextTaskText" style="color:var(--muted); margin-top:6px;">
          Read the directions, then click Next.
        </div>
      </div>

      <div class="box hints" id="hintsBox">
        <strong>Hint</strong>
        <div id="hintsText" style="color:var(--muted); margin-top:6px;"></div>
      </div>

      <div class="box">
        <strong>Targets for Day 1</strong>
        <div style="color:var(--muted); margin-top:6px;">
          <div>• Geography in <b>Mesoamerica</b> shaped Maya life (farming, water, cities, travel).</div>
          <div>• Maya government: <b>city-states</b> ruled by powerful kings.</div>
          <div>• Maya religion: kings connected to gods; <b>priests</b> ran ceremonies (T/F: human sacrifices).</div>
          <div>• Maya innovations: <b>calendars</b>, <b>astronomy</b>, and <b>writing</b> (codices/glyphs).</div>
          <div>• Society: <b>women helped form alliances</b> through marriage.</div>
          <div>• Picture Analysis purpose: use the image to infer <b>challenges</b> + <b>advantages</b> of a jungle city.</div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Modal for vocab -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="Vocabulary definition">
    <div class="modal">
      <h4 id="modalTitle">Vocabulary</h4>
      <div id="modalText" class="modal-body"></div>
      <div class="row">
        <button id="modalClose" type="button">Close</button>
      </div>
    </div>
  </div>

  <script>
    // --- Vocab bank (clickable words) ---
    const VOCAB = {
      "mesoamerica": "A region in southern Mexico and Central America where the Maya lived.",
      "terrain": "The type of land (jungle, mountains, desert, etc.).",
      "city-state": "A city that acts like its own small country with its own leaders and rules.",
      "slash-and-burn": "A farming method where people cut plants and burn them; the ashes help the soil for a short time.",
      "agriculture": "Farming—growing crops and raising food.",
      "priest": "A religious leader who leads ceremonies and rituals.",
      "ritual": "A special ceremony done for religious reasons.",
      "human sacrifice": "A religious practice where a person is killed as an offering to the gods.",
      "descendant": "Someone who comes from a family line (child, grandchild, etc.).",
      "astronomy": "The study of the stars and sky.",
      "calendar": "A system for tracking time (days, months, years).",
      "eclipse": "When the sun or moon seems to disappear because something passes in front of it.",
      "glyph": "A symbol used in writing (a picture that can represent a word or sound).",
      "codex": "A Maya book (often made from bark paper) that recorded important information.",
      "codices": "Plural of codex - Maya books (often made from bark paper) that recorded important information.",
      "alliance": "A partnership between groups, often for protection or power.",
      "intermarriage": "Marriage between people from different groups to build alliances.",
      "pyramid": "A large stone structure, often used as a temple.",
      "temple": "A building used for worship.",
      "evidence": "Proof from the text (copy 4–6 words) that supports your answer."
    };

    function vocabify(text) {
      const keys = Object.keys(VOCAB).sort((a, b) => b.length - a.length);
      let out = text;
      keys.forEach(k => {
        const safe = k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(`\\b${safe}\\b`, "gi");
        out = out.replace(re, (match) => `<span class="vocab" data-vocab="${k.toLowerCase()}">${match}</span>`);
      });
      return out;
    }

    // --- Spanish Helper (ELL scaffold) ---
    const SPANISH_HELP = {
      intro: {
        enTitle: "Spanish Helper (ELL Support)",
        en: [
          "You do NOT need to translate everything.",
          "Read one sentence at a time. Circle key words.",
          "Use the stems to write in English, then check the Spanish hint if stuck.",
          "Best study move: say the answer out loud, then write it."
        ],
        es: [
          "No necesitas traducir todo.",
          "Lee una oración a la vez. Encierra palabras clave.",
          "Usa los marcos de oración en inglés, y revisa la pista en español si te atoras.",
          "Mejor forma de estudiar: di la respuesta en voz alta y luego escríbela."
        ]
      },
      starters: {
        enTitle: "Sentence Starters (English → Spanish hint)",
        items: [
          { en: "Geography shapes life because…", es: "La geografía afecta la vida porque…" },
          { en: "One example is… because…", es: "Un ejemplo es… porque…" },
          { en: "Both civilizations…, but… while…", es: "Ambas civilizaciones…, pero… mientras…" },
          { en: "The Inca were easier to conquer because…", es: "Los incas fueron más fáciles de conquistar porque…" },
          { en: "Geography affects life because…", es: "La geografía afecta la vida porque…" }
        ]
      },
      keyWords: {
        enTitle: "Key Words (Don’t translate the whole paragraph)",
        items: [
          { en: "region", es: "región" },
          { en: "mountains", es: "montañas" },
          { en: "jungle", es: "selva" },
          { en: "lake", es: "lago" },
          { en: "capital", es: "capital" },
          { en: "empire", es: "imperio" },
          { en: "city", es: "ciudad" },
          { en: "roads", es: "caminos / carreteras" },
          { en: "disease", es: "enfermedad" },
          { en: "civil war", es: "guerra civil" }
        ]
      },
      studyTips: {
        enTitle: "Study Tips (English + Social Studies)",
        tips: [
          { en: "Find the place (where).", es: "Encuentra el lugar (dónde)." },
          { en: "Find the landform (mountain/jungle/lake).", es: "Encuentra el tipo de tierra (montaña/selva/lago)." },
          { en: "Ask: How would people get food, water, and travel?", es: "Pregunta: ¿Cómo conseguirían comida, agua y transporte?" },
          { en: "Use 4–6 words of evidence only when the worksheet asks.", es: "Usa 4–6 palabras de evidencia solo cuando la hoja lo pida." }
        ]
      }
    };
    const CHUNKS = [
      {
        tag: "How to",
        skill: "Routine",
        title: "How to Use This Maya Reading Helper",
        body: `
        <p><b>Today we’re doing 3 things:</b> read → write → picture analysis.</p>
        <ol>
          <li><b>Read the slide</b> on the left (chunked).</li>
          <li><b>Answer the worksheet questions</b> on your paper.</li>
          <li><b>Tap highlighted vocab</b> if you need help.</li>
          <li>When we reach <b>Picture Analysis</b>, use the image to infer a <b>challenge</b> and an <b>advantage</b>.</li>
        </ol>
        <p><b>Partner rule:</b> If you’re stuck, re-read → ask partner → raise hand.</p>
        <p style="color: rgba(203,213,225,.95);"><b>Mr. Naramore’s note:</b> Don’t rush. Good answers beat fast answers.</p>
      `,
        nextTask: `On your paper: write your name + date. Then be ready for the Do Now on the next slide.`,
        hint: `Use Back/Next. Use “Vocab List” if a word is confusing.`
      },
      {
        tag: "Do Now",
        skill: "Geography → Life",
        title: "Big idea: geography shapes how people live",
        body: `
        <p>${vocabify(
          "Geography shapes daily life. It affects where people can get food and water, what materials they can build with, how they travel, and what dangers they face. Today we’re focusing on the Maya and how life in the Mesoamerican jungle pushed them to solve problems in smart ways."
        )}</p>
        <p><b>Quick reminder:</b> Your answers should match the reading, not guesses.</p>
      `,
        nextTask: `Do Now (2 sentences):<br/>*Geography shapes life because ____.*<br/>*One example is ____ because ____.*`,
        hint: `Think: food, water, travel, building, protection.`
      },
      {
        tag: "Paragraph 1",
        skill: "Geography + Farming",
        title: "Maya geography + farming in the jungle",
        body: `
        <p>${vocabify(
          "The Maya lived in Mesoamerica, a region that includes parts of southern Mexico and Central America. Much of this land was hot, humid, and covered in jungle, so the Maya had to adjust how they lived and farmed. One farming method they used was slash-and-burn agriculture. Farmers cut down plants, then burned them, and the ashes helped make the soil fertile for a short time. This worked in the jungle because it cleared space for crops and helped the soil grow food—at least until the nutrients ran out and people needed new farmland."
        )}</p>
      `,
        nextTask: `Checkpoint (write in complete sentences):<br/>1) *The Maya lived in ____.*<br/>2) *One farming method was ____.*<br/>3) *Slash-and-burn worked because ____.*`,
        hint: `Find the sentence that explains what burning does to the soil.`
      },
      {
        tag: "Paragraph 2",
        skill: "Government + Religion",
        title: "City-states, kings, and priests",
        body: `
        <p>${vocabify(
          "The Maya were not one giant empire. Instead, they lived in city-states, meaning each major city had its own rulers and rules. Maya kings were seen as extremely powerful because people believed the king was a descendant of the Sun God. Religion shaped daily life, and priests were important leaders because they ran ceremonies and helped guide the community’s relationship with the gods. In some Maya ceremonies, priests performed human sacrifices as part of religious rituals. Maya religion influenced how they built temples, how they held festivals, and how leaders kept power."
        )}</p>
      `,
        nextTask: `Checkpoint:<br/>1) *A city-state is ____.*<br/>2) *Maya kings were powerful because ____.*<br/>3) T/F (and correct it if false): *Priests performed human sacrifices.*`,
        hint: `Look for “descendant of the Sun God.”`
      },
      {
        tag: "Paragraph 3",
        skill: "Innovations + Society",
        title: "Calendars, astronomy, writing — and alliances",
        body: `
        <p>${vocabify(
          "The Maya are famous for innovations, especially their calendar system and their study of the sky (astronomy). Their calendars weren’t just dates—they helped the Maya know when to plant and harvest, plan festivals, and even predict events like eclipses. Because the calendar connected to farming and religion, it affected the whole culture. The Maya also developed a writing system using glyphs and made books called codices to record important information. Maya society relied on relationships between city-states, and women played an important role in building alliances through marriage, which helped connect powerful families."
        )}</p>
      `,
        nextTask: `Checkpoint:<br/>1) *The Maya used calendars to ____.* (name 2 uses)<br/>2) *One Maya innovation was ____.*<br/>3) *Women helped build alliances by ____.*`,
        hint: `Find the part about planting/harvesting and predicting eclipses.`
      },
      {
        tag: "Picture Analysis",
        skill: "Infer from evidence",
        title: "Picture Analysis: What does this environment tell you?",
        body: `
        <p><b>Look at the image.</b> Your goal is to infer how geography shaped life for the Maya.</p>
        <p>On your worksheet, write <b>one challenge</b>, <b>one unique advantage</b>, and <b>evidence</b> (copy 4–6 words from the caption or slide).</p>
      `,
        nextTask: `Picture Analysis (Maya):<br/>*One challenge was ____.*<br/>*One unique advantage was ____.*<br/>*Evidence (4–6 words): ____.*<br/>Then add one sentence: *Geography affected Maya life because ____.*`,
        hint: `Use the captions. Image 1: jungle + stone temples. Image 2: a codex with glyphs. Think: what problems did they solve, and what did they care about enough to record?`
      }
    ];

    // --- Early finisher quiz bank ---
    const FINISHER_QUIZ = [
      {
        q: "Mesoamerica is…",
        correct: "A region in southern Mexico and Central America",
        wrong: ["A mountain range", "A city built on a lake"]
      },
      {
        q: "Slash-and-burn agriculture is…",
        correct: "Cutting plants and burning them so ashes help the soil",
        wrong: ["Farming on floating gardens", "Farming with irrigation canals"]
      },
      {
        q: "A city-state is…",
        correct: "A city that acts like its own country",
        wrong: ["A city ruled by Spain", "A city built on water"]
      },
      {
        q: "Astronomy is…",
        correct: "The study of the stars and sky",
        wrong: ["A type of pyramid", "A kind of jungle plant"]
      },
      {
        q: "A codex is…",
        correct: "A Maya book that recorded information",
        wrong: ["A stone road", "A water-carrying structure"]
      }
    ];

    // --- UI State ---
    let idx = 0;

    const elTitle = document.getElementById("chunkTitle");
    const elBody = document.getElementById("chunkBody");
    const elProgress = document.getElementById("progressText");
    const elChunkTag = document.getElementById("chunkTag");
    const elSkillTag = document.getElementById("skillTag");
    const elNextTaskText = document.getElementById("nextTaskText");
    const elHintsBox = document.getElementById("hintsBox");
    const elHintsText = document.getElementById("hintsText");

    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const btnHint = document.getElementById("btnHint");
    const btnVocab = document.getElementById("btnVocab");
    const btnSpanish = document.getElementById("btnSpanish");
    const btnFontSm = document.getElementById("btnFontSm");
    const btnFontMd = document.getElementById("btnFontMd");
    const btnFontLg = document.getElementById("btnFontLg");
    const btnFontXl = document.getElementById("btnFontXl");

    // Early finisher elements
    const finisherWrap = document.getElementById("finisherWrap");
    const btnFinisherToggle = document.getElementById("btnFinisherToggle");
    const finisherTabs = document.getElementById("finisherTabs");
    const finisherQuiz = document.getElementById("finisherQuiz");
    const pictureAnalysisBox = document.getElementById("pictureAnalysisBox");

    // Modal
    const backdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const modalText = document.getElementById("modalText");
    const modalClose = document.getElementById("modalClose");

    // Theme toggle (dark/light)
    const btnTheme = document.getElementById("btnTheme");

    function applyTheme(theme) {
      const t = theme === "light" ? "light" : "dark";
      document.body.setAttribute("data-theme", t);
      if (btnTheme) btnTheme.textContent = (t === "light") ? "Dark Mode" : "Bright Mode";
      try { localStorage.setItem("eaIntroTheme", t); } catch (e) {}
    }

    function loadTheme() {
      let saved = "dark";
      try { saved = localStorage.getItem("eaIntroTheme") || "dark"; } catch (e) {}
      applyTheme(saved);
    }

    function render() {
      const c = CHUNKS[idx];
      elTitle.textContent = c.title;
      elBody.innerHTML = c.body;
      elProgress.textContent = `Slide ${idx + 1} of ${CHUNKS.length}`;
      elChunkTag.textContent = c.tag;
      elSkillTag.textContent = `Skill: ${c.skill}`;
      elNextTaskText.innerHTML = c.nextTask;

      // Hide hints by default each chunk
      elHintsBox.style.display = "none";
      elHintsText.textContent = c.hint || "";

      // Buttons
      btnPrev.disabled = (idx === 0);
      btnNext.disabled = (idx === CHUNKS.length - 1);

      // Show early finisher ONLY on final slide
      const isFinal = idx === CHUNKS.length - 1;
      finisherWrap.style.display = isFinal ? "block" : "none";

      // Picture analysis: show ONLY on the final slide (Maya only)
      if (pictureAnalysisBox) {
        const isPictureSlide = (idx === CHUNKS.length - 1);
        pictureAnalysisBox.style.display = isPictureSlide ? "block" : "none";
      }

      // If final chunk, ensure quiz is rendered once
      if (isFinal) {
        renderFinisherQuiz();
      }

      // Attach vocab click listeners
      document.querySelectorAll(".vocab").forEach(span => {
        span.setAttribute("tabindex", "0");
        span.setAttribute("role", "button");
        span.setAttribute("aria-pressed", "false");
        const spanKey = (span.getAttribute("data-vocab") || "").toLowerCase();
        if (VOCAB[spanKey]) span.setAttribute("title", VOCAB[spanKey]);

        const activate = () => {
          document.querySelectorAll(".vocab.vocab-active").forEach(el => el.classList.remove("vocab-active"));
          document.querySelectorAll(".vocab.vocab-selected").forEach(el => {
            el.classList.remove("vocab-selected");
            el.setAttribute("aria-pressed", "false");
          });
          span.classList.add("vocab-active");
          span.classList.add("vocab-selected");
          span.setAttribute("aria-pressed", "true");
          setTimeout(() => span.classList.remove("vocab-active"), 650);

          const key = (span.getAttribute("data-vocab") || "").toLowerCase();
          showVocab(key, span.textContent);
        };

        span.addEventListener("click", activate);
        span.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            activate();
          }
        });
      });

      // Bind image expand/close for slide content + side panels
      bindImageCardInteractions(document);
    }

    // --- Reading font size controls (LEFT reading only) ---
    const SIZE_CLASS = { sm: "reading-sm", md: "reading-md", lg: "reading-lg", xl: "reading-xl" };

    function setReadingSize(size) {
      const chunkEl = document.querySelector("section.card.chunk");
      if (!chunkEl) return;
      Object.values(SIZE_CLASS).forEach(cls => chunkEl.classList.remove(cls));
      const cls = SIZE_CLASS[size] || SIZE_CLASS.md;
      chunkEl.classList.add(cls);
      try { localStorage.setItem("eaIntroReadingSize", size); } catch (e) { }
    }

    function loadReadingSize() {
      let size = "md";
      try { size = localStorage.getItem("eaIntroReadingSize") || "md"; } catch (e) { }
      setReadingSize(size);
    }

    function showVocab(key, displayWord) {
      const def = VOCAB[key] || VOCAB[displayWord.toLowerCase()] || "Definition not found.";
      modalTitle.textContent = displayWord;
      modalText.innerHTML = `<div class="vocab-def"><strong>${displayWord}</strong><div class="muted">${def}</div></div>`;
      modalText.style.whiteSpace = "normal";
      backdrop.style.display = "flex";
    }

    function closeModal() { backdrop.style.display = "none"; }

    btnPrev.addEventListener("click", () => { if (idx > 0) { idx--; render(); } });
    btnNext.addEventListener("click", () => { if (idx < CHUNKS.length - 1) { idx++; render(); } });

    btnHint.addEventListener("click", () => {
      const c = CHUNKS[idx];
      elHintsText.textContent = c.hint || "Re-read the chunk and look for key vocabulary words.";
      elHintsBox.style.display = (elHintsBox.style.display === "none") ? "block" : "none";
    });

    btnVocab.addEventListener("click", () => {
      modalTitle.textContent = "Vocab List";
      const entries = Object.entries(VOCAB).sort((a, b) => a[0].localeCompare(b[0]));
      const listHtml = entries.map(([k]) => (
        `<button type="button" class="vocab-item" data-vocab="${k}">${k.toUpperCase()}</button>`
      )).join("");
      const first = entries[0];
      modalText.innerHTML = `
      <div class="vocab-list">
        <div class="vocab-items" id="vocabItems">${listHtml}</div>
        <div class="vocab-def" id="vocabDef">
          <strong>${first ? first[0].toUpperCase() : "Term"}</strong>
          <div class="muted">${first ? first[1] : "Definition not found."}</div>
        </div>
      </div>
    `;
      const items = modalText.querySelectorAll(".vocab-item");
      items.forEach((btn, i) => {
        if (i === 0) btn.classList.add("active");
        btn.addEventListener("click", () => {
          items.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const key = (btn.getAttribute("data-vocab") || "").toLowerCase();
          const def = VOCAB[key] || "Definition not found.";
          const defBox = modalText.querySelector("#vocabDef");
          if (defBox) {
            defBox.innerHTML = `<strong>${key.toUpperCase()}</strong><div class="muted">${def}</div>`;
          }
        });
      });
      modalText.style.whiteSpace = "normal";
      backdrop.style.display = "flex";
    });

    btnFontSm.addEventListener("click", () => setReadingSize("sm"));
    btnFontMd.addEventListener("click", () => setReadingSize("md"));
    btnFontLg.addEventListener("click", () => setReadingSize("lg"));
    btnFontXl.addEventListener("click", () => setReadingSize("xl"));

    if (btnSpanish) {
      btnSpanish.addEventListener("click", () => {
        modalTitle.textContent = SPANISH_HELP.intro.enTitle;

        const introEn = SPANISH_HELP.intro.en.map(t => `<li>${t}</li>`).join("");
        const introEs = SPANISH_HELP.intro.es.map(t => `<li>${t}</li>`).join("");

        const starters = SPANISH_HELP.starters.items
          .map(s => `<div style="margin:8px 0;"><b>${s.en}</b><div class="muted">${s.es}</div></div>`)
          .join("");

        const words = SPANISH_HELP.keyWords.items
          .map(w => `<div style=\"display:flex; justify-content:space-between; gap:12px; padding:6px 0; border-bottom:1px solid var(--line);\"><span><b>${w.en}</b></span><span class=\"muted\">${w.es}</span></div>`)
          .join("");

        const tips = SPANISH_HELP.studyTips.tips
          .map(t => `<div style="margin:8px 0;"><b>${t.en}</b><div class="muted">${t.es}</div></div>`)
          .join("");

        modalText.innerHTML = `
          <div class="vocab-def" style="min-height:auto;">
            <strong>Quick help (English)</strong>
            <ul style="margin:8px 0 10px; padding-left:18px;">${introEn}</ul>
            <strong>Ayuda rápida (Español)</strong>
            <ul style="margin:8px 0 0; padding-left:18px;">${introEs}</ul>
          </div>

          <div class="vocab-def" style="min-height:auto; margin-top:12px;">
            <strong>${SPANISH_HELP.starters.enTitle}</strong>
            <div class="muted" style="margin-top:6px;">Use the English sentence starter, then check the Spanish hint.</div>
            ${starters}
          </div>

          <div class="vocab-def" style="min-height:auto; margin-top:12px;">
            <strong>${SPANISH_HELP.keyWords.enTitle}</strong>
            <div class="muted" style="margin-top:6px;">Look for these words first. Then read the sentence again.</div>
            ${words}
          </div>

          <div class="vocab-def" style="min-height:auto; margin-top:12px;">
            <strong>${SPANISH_HELP.studyTips.enTitle}</strong>
            ${tips}
          </div>
        `;

        modalText.style.whiteSpace = "normal";
        backdrop.style.display = "flex";
      });
    }

    backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeModal(); });
    modalClose.addEventListener("click", closeModal);
    window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

    if (btnTheme) {
      btnTheme.addEventListener("click", () => {
        const current = document.body.getAttribute("data-theme") || "dark";
        applyTheme(current === "light" ? "dark" : "light");
      });
    }

    // --- Early finisher logic ---
    let finisherOpen = false;

    function setFinisherOpen(open) {
      finisherOpen = open;
      const panelsVisible = open ? "block" : "none";
      finisherTabs.style.display = panelsVisible;
      document.querySelectorAll('[data-finisher-panel]').forEach(p => {
        // keep current panel active but respect open state
        p.style.display = open ? (p.classList.contains('active') ? 'block' : 'none') : 'none';
      });
      btnFinisherToggle.textContent = open ? "Close Choice Board" : "Open Choice Board";
    }

    btnFinisherToggle.addEventListener("click", () => {
      setFinisherOpen(!finisherOpen);
    });

    // Default: closed until student opens
    setFinisherOpen(false);

    // Picture analysis: expand/collapse images (bind after render too)
    function collapsePictureCards(except) {
      document.querySelectorAll(".img-card.expanded").forEach(card => {
        if (card !== except) card.classList.remove("expanded");
      });
    }

    function bindImageCardInteractions(root = document) {
      root.querySelectorAll(".img-card img").forEach(img => {
        if (img.dataset.zoomBound === "1") return;
        img.dataset.zoomBound = "1";
        img.addEventListener("click", () => {
          const card = img.closest(".img-card");
          if (!card) return;
          if (card.classList.contains("expanded")) {
            card.classList.remove("expanded");
            return;
          }
          collapsePictureCards(card);
          card.classList.add("expanded");
        });
      });

      root.querySelectorAll(".img-card .img-close").forEach(btn => {
        if (btn.dataset.zoomBound === "1") return;
        btn.dataset.zoomBound = "1";
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const card = btn.closest(".img-card");
          if (card) card.classList.remove("expanded");
        });
      });
    }

    document.querySelectorAll('[data-finisher-tab]').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('[data-finisher-tab]').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const key = tab.getAttribute('data-finisher-tab');
        document.querySelectorAll('[data-finisher-panel]').forEach(p => {
          p.classList.remove('active');
          p.style.display = 'none';
        });
        const panel = document.querySelector(`[data-finisher-panel="${key}"]`);
        if (panel) {
          panel.classList.add('active');
          if (finisherOpen) panel.style.display = 'block';
        }
      });
    });

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function renderFinisherQuiz() {
      // Build self-checking MC items
      finisherQuiz.innerHTML = FINISHER_QUIZ.map((item, i) => {
        const opts = shuffle([item.correct, ...item.wrong]);
        return `
        <div class="quiz-q" data-q-index="${i}">
          <div class="q">${i + 1}) ${item.q}</div>
          <div class="quiz-opts">
            ${opts.map(opt => {
          const safe = opt.replace(/"/g, '&quot;');
          return `<div class="quiz-opt" data-answer="${safe}">${opt}</div>`;
        }).join('')}
          </div>
        </div>
      `;
      }).join('');

      // Bind clicks
      finisherQuiz.querySelectorAll('.quiz-q').forEach((qEl) => {
        const qIndex = Number(qEl.getAttribute('data-q-index'));
        const item = FINISHER_QUIZ[qIndex];
        qEl.querySelectorAll('.quiz-opt').forEach((optEl) => {
          optEl.addEventListener('click', () => {
            // lock this question after first click
            if (qEl.getAttribute('data-locked') === 'true') return;
            qEl.setAttribute('data-locked', 'true');

            const chosen = optEl.textContent;
            const correct = chosen === item.correct;
            optEl.classList.add(correct ? 'correct' : 'wrong');

            // also reveal the correct one
            qEl.querySelectorAll('.quiz-opt').forEach((el) => {
              if (el.textContent === item.correct) el.classList.add('correct');
            });
          });
        });
      });
    }

    // Initial render
    loadTheme();
    render();
    loadReadingSize();
  </script>
</body>

</html>
